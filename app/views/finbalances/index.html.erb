<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "finbalances/index", "data-turbo-track": "reload" %>
<% end %>
<% content_for :title, "支払い・請求管理一覧" %>
<div data-controller="finbalance-index" style="width:100%;">
  <%= render partial: "layouts/sidebar" %>
  <div class="main-content">
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-chart-line"></i> 支払い・請求管理一覧</h1>
      </div>

      <div class="content-container">
        <!-- Summary Section -->
        <div class="summary-section">
          <div class="summary-title">
            <i class="fas fa-calculator"></i>
            収益サマリー
          </div>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">総収入</div>
              <div class="summary-value">¥<%= @totals.total_income&.to_formatted_s(:delimited)  %></div>
            </div>
            <div class="summary-item">
              <div class="summary-label">総支出</div>
              <div class="summary-value">¥<%= @totals.total_cost&.to_formatted_s(:delimited)  %></div>
            </div>
            <div class="summary-item">
              <div class="summary-label">純利益</div>
              <div class="summary-value">¥<%= @totals.total_balance&.to_formatted_s(:delimited)  %></div>
            </div>
            <div class="summary-item">
              <div class="summary-label">平均利益率</div>
              <div class="summary-value"><%= profit_margin(@totals.total_income, @totals.total_cost) %></div>
            </div>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
          <div class="filter-header">
            <div class="filter-title">
              <div class="section-icon"><i class="fas fa-filter"></i></div>
              検索・フィルター
            </div>
          </div>
          <div class="filter-content">
            <%= search_form_for @q, url: finbalances_path, method: :get, local: true do |f| %>
              <div class="filter-grid">
                <div class="form-group">
                  <%= f.label :mbl_cont, "MBL", class: "form-label" %>
                  <%= f.search_field :mbl_cont, 
                      class: "form-input",
                      value: @q.mbl_cont %>
                </div>

                <div class="form-group">
                  <%= f.label :id_string_cont, "ID番号", class: "form-label" %>
                  <%= f.search_field :id_string_cont, 
                      class: "form-input",
                      value: @q.id_string_cont %>
                </div>

                <div class="form-group">
                  <%= f.label :event_shipment_shipment_eq, "種別", class: "form-label" %>
                  <%= f.select :event_shipment_shipment_eq, 
                      options_for_select([
                        ['すべて', '']] + 
                        EventShipment.shipments.map { |k,v| [I18n.t("activerecord.attributes.event_shipment.shipment.#{k}"), k,v] }, @q.event_shipment_shipment_eq), 
                      {}, 
                      { class: "form-select" } %>
                </div>

                <div class="form-group">
                  <%= f.label :event_shipment_mode_eq, "Method", class: "form-label" %>
                  <%= f.select :event_shipment_mode_eq,
                      options_for_select([
                        ['すべて', '']] + 
                        EventShipment.modes.map { |k,v| [I18n.t("activerecord.attributes.event_shipment.mode.#{k}"), k,v] }, @q.event_shipment_mode_eq), 
                      {}, 
                      { class: "form-select" } %>
                </div>

                <div class="form-group">
                  <%= f.label :event_shipment_port_of_loading_cont, "積み地", class: "form-label" %>
                  <%= f.search_field :event_shipment_port_of_loading_cont, 
                      class: "form-input",
                      value: @q.event_shipment_port_of_loading_cont,
                      data: {
                        action: "click->finbalance-index#showPortSearchModal",
                        port_field: "event_shipment_port_of_loading_cont"
                  } %>
                </div>

                <div class="form-group">
                  <%= f.label :event_shipment_port_of_discharge_cont, "揚げ地", class: "form-label" %>
                  <%= f.search_field :event_shipment_port_of_discharge_cont, 
                      class: "form-input",
                      value: @q.event_shipment_port_of_discharge_cont,
                      data: {
                        action: "click->finbalance-index#showPortSearchModal",
                        port_field: "event_shipment_port_of_discharge_cont"
                  } %>
                </div>

                <div class="form-group">
                  <%= f.label :client_name_cont, "Client名", class: "form-label" %>
                  <%= f.search_field :client_name_cont, 
                      placeholder: "Client name(english)", 
                      class: "form-input",
                      value: params[:q]&.[](:client_name_cont) %>
                </div>
                <div class="form-group">
                  <%= f.label :accounting_month_gteq, "計上月（開始）", class: "form-label" %>
                  <%= f.search_field :accounting_month_gteq,
                        class: "form-input",
                        type: "month",
                        value: @month_gteq_display %>
                </div>

                <div class="form-group">
                  <%= f.label :accounting_month_lteq, "計上月（終了）", class: "form-label" %>
                  <%= f.search_field :accounting_month_lteq,
                        class: "form-input",
                        type: "month",
                        value: @month_lteq_display %>
                </div>
                <div class="form-group">
                  <%= f.submit "検索実行", class: "btn btn-primary" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        
        <!-- Table Section -->
        <div class="table-section">
          <div class="table-header">
            <div class="table-title">
              <div class="section-icon"><i class="fas fa-table"></i></div>
              支払い・請求管理リスト
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>MBL</th>
                  <th>ID番号</th>
                  <th>輸出/輸入</th>
                  <th>Method</th>
                  <th>港</th>
                  <th>CLIENT名</th>
                  <th>スケジュール</th>
                  <th>コンテナ本数</th>
                  <th>計上月</th>
                  <th>支払い・請求管理</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <% @events.each do |event| %>
                  <tr>
                    <td class="text-sm font-medium"><%= list_item_with_na(event.mbl) %></td>
                    <td class="text-sm font-medium"><%= list_item_with_na(event.id_string) %></td>
                    <td>
                      <span class="type-badge <%= get_shipment_badge_class(event.shipment) %>"><%= event.shipment.present? ? EventShipment.shipments.keys[event.shipment] : 'N/A' %></span>
                    </td>
                    <td>
                      <span class="method-badge <%= get_method_badge_class(event.mode) %>"><%= event.mode.present? ? EventShipment.modes.keys[event.mode] : 'N/A' %></span>
                    </td>
                    <td class="port-info">
                      <div class="port-row port-loading"><%= list_item_with_na(event.pol) %></div>
                      <div class="port-row port-discharge"><%= list_item_with_na(event.pod) %></div>
                    </td>
                    <td class="multi-line-cell">
                      <div class="cell-row">
                        <div class="cell-value truncate-text" title="<%= list_item_with_na(event.client) %>"><%= list_item_with_na(event.client) %></div>
                      </div>
                    </td>
                    <td class="multi-line-cell">
                      <div class="cell-row">
                        <span class="cell-value">ATD：<%= date_only(event.atd) %></span>
                      </div>
                      <div class="cell-row">
                        <span class="cell-value">ATA：<%= date_only(event.ata) %></span>
                      </div>
                    </td>
                    <td class="multi-line-cell">
                      <% finbalance_index_container_count(@containers[event.id] ).each do |type, count| %>
                        <div class="cell-row">
                          <span class="cell-value"><%= type %>：</span>
                          <span class="cell-value"><%= count %>本</span>
                        </div>
                      <% end %>
                    </td>
                    <td class="text-sm"><%= year_month_only(event.accounting_month) %></td>
                    <td class="financial-summary">
                      <div class="financial-row">
                        <span class="financial-label">収入</span>
                        <span class="financial-value text-income"><%= event.income&.to_formatted_s(:delimited) %></span>
                      </div>
                      <div class="financial-row">
                        <span class="financial-label">支出</span>
                        <span class="financial-value text-expense"><%= event.cost&.to_formatted_s(:delimited) %></span>
                      </div>
                      <div class="financial-row financial-calculation">
                        <span class="financial-label">差引</span>
                        <span class="financial-value financial-total <%= event.balance || 0 < 0 ? 'negative' : '' %>"><%= event.balance&.to_formatted_s(:delimited) %></span>
                      </div>
                      <div class="financial-row">
                        <span class="financial-label">利益率</span>
                        <span class="financial-value financial-margin <%= event.balance || 0 < 0 ? 'negative' : '' %>"><%= profit_margin(event.income, event.cost)%></span>
                      </div>
                    </td>
                    <td>
                      <a href="#" class="action-link">
                        <i class="fas fa-edit"></i> 編集
                      </a>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <%= render "layouts/port_search" %>
</div>
