<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>案件編集 - 物流管理システム</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .sidebar-title {
            color: #2196F3;
            font-size: 16px;
            font-weight: 600;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover {
            background: #f0f8ff;
            color: #2196F3;
        }

        .sidebar-menu a.active {
            background: #e3f2fd;
            color: #2196F3;
            border-right: 3px solid #2196F3;
        }

        .sidebar-icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            background: #f5f5f5;
            margin-left: 250px;
            overflow-y: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0;
            background: #f5f5f5;
        }

        .header {
            background: white;
            color: #333;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .form-container {
            padding: 0 30px 30px;
        }

        .form-section {
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #667eea;
            overflow: hidden;
        }

        .section-header {
            padding: 20px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: #e3f2fd;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .accordion-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: #667eea;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .section-content {
            padding: 25px;
            display: block;
            transition: all 0.3s ease;
        }

        .form-section.collapsed .section-content {
            display: none;
        }

        .form-section.collapsed .accordion-toggle {
            transform: rotate(180deg);
        }

        .section-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .form-grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: #e74c3c;
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .date-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: #e8f5e8;
            color: #2e7d32;
        }

        .chat-widgets {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .chat-widget {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 300px;
            max-height: 400px;
            overflow: hidden;
        }

        .chat-widget.minimized {
            max-height: 50px;
        }

        .chat-widget.minimized .chat-content,
        .chat-widget.minimized .chat-input {
            display: none;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .chat-header.business {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        }

        .chat-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
        }

        .chat-content {
            padding: 15px;
            height: 200px;
            overflow-y: auto;
        }

        .chat-message {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .cargo-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .cargo-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 14px;
            min-width: 1000px;
        }

        .cargo-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            border-bottom: 2px solid #e1e8ed;
            border-right: 1px solid #e1e8ed;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cargo-table th:last-child {
            border-right: none;
        }

        .cargo-table td {
            padding: 8px;
            border-bottom: 1px solid #e1e8ed;
            border-right: 1px solid #e1e8ed;
            text-align: center;
        }

        .cargo-table td:last-child {
            border-right: none;
        }

        .table-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
            background: white;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .table-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .cargo-table tbody tr:hover {
            background: #f8f9fa;
        }

        .container-number-input {
            min-width: 140px;
        }

        .seal-number-input {
            min-width: 120px;
        }

        .container-type-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
            background: white;
            transition: all 0.3s ease;
            min-width: 110px;
        }

        .container-type-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .file-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .file-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .file-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 2001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .file-panel.active {
            right: 0;
        }

        .file-panel-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-panel-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .file-panel-close:hover {
            background: #e9ecef;
            color: #333;
        }

        .file-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .file-upload-area {
            border: 2px dashed #e1e8ed;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover,
        .file-upload-area.drag-over {
            border-color: #667eea;
            background: #f0f8ff;
        }

        .file-upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-upload-text {
            color: #666;
            margin-bottom: 10px;
        }

        .file-upload-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .file-upload-button:hover {
            background: #5a6fd8;
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .file-main {
            display: flex;
            align-items: center;
            padding: 15px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .file-icon.pdf { background: #dc3545; }
        .file-icon.image { background: #28a745; }
        .file-icon.excel { background: #198754; }
        .file-icon.word { background: #0d6efd; }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .file-details {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .file-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .file-action-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .file-action-btn.download:hover {
            color: #2196F3;
        }

        .file-action-btn.delete:hover {
            color: #dc3545;
        }

        .file-sharing {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e1e8ed;
        }

        .sharing-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .sharing-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            transition: all 0.3s ease;
        }

        .sharing-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .sharing-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .sharing-status.customer {
            background: #e3f2fd;
            color: #1976d2;
        }

        .sharing-status.business {
            background: #fff3e0;
            color: #f57c00;
        }

        .sharing-status.none {
            background: #f5f5f5;
            color: #666;
        }

        .file-preview {
            margin: 15px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
        }

        .file-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .file-counter {
            background: #667eea;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            margin-top: auto;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4a5568;
            font-weight: 500;
        }

        .user-info {
            margin-left: 12px;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .user-action {
            font-size: 12px;
            color: #667eea;
            text-decoration: none;
        }

        .user-action:hover {
            text-decoration: underline;
        }

        /* --- ここから進捗モーダル用のスタイルを追加 --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2100; /* file-panelより手前に表示 */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal_show {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            max-width: 90%;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border-radius: 0;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.active .modal_show {
            transform: translateX(0);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-content {
            padding: 25px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #e9ecef;
            color: #333;
        }

        .milestone-list {
            list-style: none;
            position: relative;
        }

        .milestone-list::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e1e8ed;
        }

        .milestone-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .milestone-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        .milestone-icon.complete { background: #4CAF50; color: white; }
        .milestone-icon.current { background: #667eea; color: white; }
        .milestone-icon.pending { background: #e1e8ed; color: #666; }

        .milestone-content {
            flex: 1;
        }

        .milestone-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        /* --- ここまで進捗モーダル用のスタイルを追加 --- */

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .chat-widgets {
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: calc(100% - 40px);
                max-width: 300px;
            }
            
            .chat-widget {
                width: 100%;
            }
            
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .file-panel {
                width: 100%;
                right: -100%;
            }

            .file-main {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .file-actions {
                align-self: stretch;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">トラフィックカレンダー</div>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active"><span class="sidebar-icon"><i class="fas fa-plus"></i></span>新規案件登録</a></li>
            <li><a href="#"><span class="sidebar-icon"><i class="fas fa-calendar-alt"></i></span>カレンダー</a></li>
            <li><a href="#"><span class="sidebar-icon"><i class="fas fa-list"></i></span>案件一覧</a></li>
            <li><a href="#"><span class="sidebar-icon"><i class="fas fa-users"></i></span>ユーザー管理</a></li>
            <li><a href="#"><span class="sidebar-icon"><i class="fas fa-chart-bar"></i></span>収支管理</a></li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">田</div>
                <div class="user-info">
                    <div class="user-name">田中 太郎</div>
                    <a href="#" class="user-action">ログアウト</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-box"></i> 案件編集</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary">
                        <i class="fas fa-calculator"></i> 収支編集
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> MarineTraffic連携
                    </button>
                    <button class="btn btn-secondary" id="showMilestoneBtn">
                        <i class="fas fa-clipboard-list"></i> 進捗表示
                    </button>
                    <button class="btn btn-secondary" onclick="toggleFilePanel()">
                        <i class="fas fa-paperclip"></i> 添付ファイル
                        <span class="file-counter" id="fileCounter">3</span>
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-times"></i> キャンセル
                    </button>
                    <button class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>

            <div class="form-container">
                <div class="form-section" id="basicInfo">
                    <div class="section-header" onclick="toggleSection('basicInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-info-circle"></i></div>
                            基本情報
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="form-grid grid-3">
                            <div class="form-group">
                                <label class="form-label">ID NO.</label>
                                <input type="text" class="form-input" placeholder="自動生成" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">請求 <span class="required">*</span></label>
                                <input type="text" class="form-input" id="billing-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SOA</label>
                                <input type="text" class="form-input" id="soa-input">
                            </div>
                        </div>

                        <div class="form-grid grid-2" style="margin-top: 20px;">
                            <div class="form-group">
                                <label class="form-label">MBL NO.</label>
                                <input type="text" class="form-input" id="mbl-input" value="MBL-XYZ123">
                            </div>
                            <div class="form-group">
                                <label class="form-label">HBL NO.</label>
                                <input type="text" class="form-input" id="hbl-input" value="HBL-ABC456">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section" id="transportInfo">
                    <div class="section-header" onclick="toggleSection('transportInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-ship"></i></div>
                            輸送情報
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="form-grid grid-2">
                            <div class="form-group">
                                <label class="form-label">EX / IM <span class="required">*</span></label>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="export" name="ex_im" value="export">
                                        <label for="export">輸入</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="import" name="ex_im" value="import">
                                        <label for="import">輸出</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">METHOD <span class="required">*</span></label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="lcl" name="method" value="lcl">
                                        <label for="lcl">LCL</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="fcl" name="method" value="fcl">
                                        <label for="fcl">FCL</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="air" name="method" value="air">
                                        <label for="air">AIR</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-grid grid-2" style="margin-top: 20px;">
                            <div class="form-group">
                                <label class="form-label">TERM</label>
                                <select class="form-select">
                                    <option value="">選択してください</option>
                                    <option value="fob">FOB</option>
                                    <option value="cif">CIF</option>
                                    <option value="ddp">DDP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">担当</label>
                                <select class="form-select">
                                    <option value="">選択してください</option>
                                    <option value="tanaka">田中</option>
                                    <option value="sato">佐藤</option>
                                    <option value="suzuki">鈴木</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid grid-4" style="margin-top: 20px;">
                            <div class="form-group">
                                <label class="form-label">VESSEL NAME</label>
                                <input type="text" class="form-input" value="CNC SULAWESI">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Voy.No</label>
                                <input type="text" class="form-input" value="3CGHCN1NC">
                            </div>
                            <div class="form-group">
                                <label class="form-label">BOOKING NO.</label>
                                <input type="text" class="form-input" value="GTD0943302">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CARRIER</label>
                                <input type="text" class="form-input" value="Cheng Lie Navigation Co." style="color: #2196F3;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section collapsed" id="stakeholderInfo">
                    <div class="section-header" onclick="toggleSection('stakeholderInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-users"></i></div>
                            関係者情報
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="form-grid grid-2">
                            <div class="form-group">
                                <label class="form-label">SHIPPER 社名</label>
                                <select class="form-select">
                                    <option value="">選択してください</option>
                                    <option value="company1">ABC Trading Co., Ltd.</option>
                                    <option value="company2">XYZ Corporation</option>
                                    <option value="company3">Tokyo Shipping Inc.</option>
                                    <option value="company4">Global Logistics Ltd.</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CONSIGNEE 社名</label>
                                <select class="form-select">
                                    <option value="">選択してください</option>
                                    <option value="consignee1">DEF Manufacturing</option>
                                    <option value="consignee2">GHI Industries</option>
                                    <option value="consignee3">JKL Distribution</option>
                                    <option value="consignee4">MNO Retail Group</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid grid-2" style="margin-top: 20px;">
                            <div class="form-group">
                                <label class="form-label">AGENT 社名</label>
                                <select class="form-select">
                                    <option value="">選択してください</option>
                                    <option value="agent1">PQR Freight Forwarder</option>
                                    <option value="agent2">STU Logistics Services</option>
                                    <option value="agent3">VWX International</option>
                                    <option value="agent4">YZ Cargo Solutions</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">AGENT 国名</label>
                                <input type="text" class="form-input">
                            </div>
                        </div>

                        <div class="form-grid grid-2" style="margin-top: 20px;">
                            <div class="form-group">
                                <label class="form-label">通関業者</label>
                                <select class="form-select">
                                    <option value="">選択してください</option>
                                    <option value="kansai" selected>株式会社関東国際</option>
                                    <option value="tokyo_customs">東京通関サービス</option>
                                    <option value="yokohama_customs">横浜カスタムス</option>
                                    <option value="osaka_customs">大阪通関</option>
                                </select>
                            </div>
                            <div class="form-group">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="form-section collapsed" id="addressInfo">
                    <div class="section-header" onclick="toggleSection('addressInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-map-marker-alt"></i></div>
                            住所情報
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="form-grid grid-3">
                            <div class="form-group">
                                <label class="form-label">集荷先</label>
                                <textarea class="form-textarea" placeholder="住所を入力してください"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">配送先</label>
                                <textarea class="form-textarea" placeholder="住所を入力してください"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">納入先</label>
                                <textarea class="form-textarea" placeholder="住所を入力してください"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section collapsed" id="scheduleInfo">
                    <div class="section-header" onclick="toggleSection('scheduleInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-calendar-check"></i></div>
                            スケジュール
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="date-grid">
                            <div class="form-group">
                                <label class="form-label">PICK UP</label>
                                <input type="date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CFS</label>
                                <input type="date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">VANNING DATE</label>
                                <input type="date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CUT OFF DATE</label>
                                <input type="date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ETD</label>
                                <input type="date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ATD</label>
                                <input type="date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ETA</label>
                                <input type="date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ATA</label>
                                <input type="date" class="form-input">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">DELIVERY</label>
                            <input type="text" class="form-input" placeholder="配送詳細">
                        </div>
                    </div>
                </div>

                <div class="form-section collapsed" id="portInfo">
                    <div class="section-header" onclick="toggleSection('portInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-anchor"></i></div>
                            港湾情報
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="form-grid grid-2">
                            <div class="form-group">
                                <label class="form-label">PLACE OF RECEIPT</label>
                                <input type="text" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PORT OF LOADING <span class="required">*</span></label>
                                <input type="text" class="form-input">
                            </div>
                        </div>

                        <div class="form-grid grid-2" style="margin-top: 20px;">
                            <div class="form-group">
                                <label class="form-label">PORT OF DISCHARGE <span class="required">*</span></label>
                                <input type="text" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PLACE OF DELIVERY</label>
                                <input type="text" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section collapsed" id="containerInfo">
                    <div class="section-header" onclick="toggleSection('containerInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-shipping-fast"></i></div>
                            コンテナ情報
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="cargo-table-container">
                            <table class="cargo-table">
                                <thead>
                                    <tr>
                                        <th>コンテナ番号</th>
                                        <th>コンテナタイプ</th>
                                        <th>コンテナサイズ</th>
                                        <th>シール番号</th>
                                        <th>備考</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" class="table-input container-number-input" value="TEMU1234567" placeholder="コンテナ番号"></td>
                                        <td>
                                            <select class="container-type-select">
                                                <option value="">選択</option>
                                                <option value="Dry" selected>Dry</option>
                                                <option value="Reefer">Reefer</option>
                                                <option value="OT">OT</option>
                                                <option value="FR">FR</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="container-type-select">
                                                <option value="">選択</option>
                                                <option value="20'" selected>20'</option>
                                                <option value="40'">40'</option>
                                                <option value="40'HC">40'HC</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="table-input seal-number-input" value="S789012" placeholder="シール番号"></td>
                                        <td><input type="text" class="table-input" placeholder="備考"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" class="table-input container-number-input" placeholder="コンテナ番号"></td>
                                        <td>
                                            <select class="container-type-select">
                                                <option value="">選択</option>
                                                <option value="Dry">Dry</option>
                                                <option value="Reefer">Reefer</option>
                                                <option value="OT">OT</option>
                                                <option value="FR">FR</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="container-type-select">
                                                <option value="">選択</option>
                                                <option value="20'">20'</option>
                                                <option value="40'">40'</option>
                                                <option value="40'HC">40'HC</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="table-input seal-number-input" placeholder="シール番号"></td>
                                        <td><input type="text" class="table-input" placeholder="備考"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" class="table-input container-number-input" placeholder="コンテナ番号"></td>
                                        <td>
                                            <select class="container-type-select">
                                                <option value="">選択</option>
                                                <option value="Dry">Dry</option>
                                                <option value="Reefer">Reefer</option>
                                                <option value="OT">OT</option>
                                                <option value="FR">FR</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="container-type-select">
                                                <option value="">選択</option>
                                                <option value="20'">20'</option>
                                                <option value="40'">40'</option>
                                                <option value="40'HC">40'HC</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="table-input seal-number-input" placeholder="シール番号"></td>
                                        <td><input type="text" class="table-input" placeholder="備考"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="addContainerRow()">
                                <i class="fas fa-plus"></i> コンテナを追加
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-section collapsed" id="productInfo">
                    <div class="section-header" onclick="toggleSection('productInfo')">
                        <div class="section-title">
                            <div class="section-icon"><i class="fas fa-boxes"></i></div>
                            商品情報
                        </div>
                        <button class="accordion-toggle"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <div class="cargo-table-container">
                            <table class="cargo-table">
                                <thead>
                                    <tr>
                                        <th>20'</th>
                                        <th>40'</th>
                                        <th>40'HC</th>
                                        <th>TYPE</th>
                                        <th>PKGS</th>
                                        <th>TYPE OF PKG</th>
                                        <th>KGS</th>
                                        <th>M3</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="number" class="table-input" value="1"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="text" class="table-input" value="REEFER"></td>
                                        <td><input type="number" class="table-input" value="197"></td>
                                        <td><input type="text" class="table-input" value="CARTON"></td>
                                        <td><input type="number" class="table-input" value="2364"></td>
                                        <td><input type="number" class="table-input" value="25"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="text" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="text" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="text" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="text" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                        <td><input type="number" class="table-input"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="addCargoRow()">
                                <i class="fas fa-plus"></i> 行を追加
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-widgets">
        <div class="chat-widget" id="customerChat">
            <div class="chat-header" onclick="toggleChat('customerChat')">
                <span><i class="fas fa-comments"></i> お客様連絡チャット</span>
                <button class="chat-toggle">−</button>
            </div>
            <div class="chat-content">
                <div class="chat-message">
                    <strong>お客様 09:15</strong><br>
                    納入日の調整をお願いします。
                </div>
                <div class="chat-message">
                    <strong>担当者 09:18</strong><br>
                    承知いたしました。確認して連絡します。
                </div>
            </div>
            <div class="chat-input">
                <input type="text" placeholder="メッセージを入力..." data-chat="customer">
            </div>
        </div>

        <div class="chat-widget" id="businessChat">
            <div class="chat-header business" onclick="toggleChat('businessChat')">
                <span><i class="fas fa-building"></i> 取引先連絡チャット</span>
                <button class="chat-toggle">−</button>
            </div>
            <div class="chat-content">
                <div class="chat-message">
                    <strong>ABC Trading 10:30</strong><br>
                    貨物の出荷準備が完了しました。
                </div>
                <div class="chat-message">
                    <strong>担当者 10:35</strong><br>
                    ありがとうございます。船積み予定を確認します。
                </div>
                <div class="chat-message">
                    <strong>ABC Trading 10:40</strong><br>
                    コンテナ番号: ABCD1234567<br>
                    よろしくお願いします。
                </div>
            </div>
            <div class="chat-input">
                <input type="text" placeholder="メッセージを入力..." data-chat="business">
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="milestone-modal-overlay">
        <div class="modal_show" id="milestone-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-tasks"></i>
                    <span id="modal-project-title"></span>
                </div>
                <button class="modal-close" onclick="closeMilestoneModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content" id="milestone-modal-content">
                </div>
        </div>
    </div>
    <div class="file-panel-overlay" id="filePanelOverlay" onclick="closeFilePanel()"></div>
    <div class="file-panel" id="filePanel">
        <div class="file-panel-header">
            <div class="file-panel-title">
                <i class="fas fa-paperclip"></i>
                添付ファイル
            </div>
            <button class="file-panel-close" onclick="closeFilePanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="file-panel-content">
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="file-upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="file-upload-text">
                    ファイルをドラッグ&ドロップ<br>
                    または クリックしてアップロード
                </div>
                <button class="file-upload-button" type="button">ファイルを選択</button>
                <input type="file" id="fileInput" multiple style="display: none;" accept="*/*">
            </div>

            <ul class="file-list" id="fileList">
                <li class="file-item">
                    <div class="file-main">
                        <div class="file-icon pdf">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">船荷証券_20250128.pdf</div>
                            <div class="file-details">
                                2.3 MB • 2025/01/28 14:30
                                <span class="sharing-status customer">お客様のみ</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn download" title="ダウンロード">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="file-action-btn delete" title="削除" onclick="deleteFile(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="file-sharing">
                        <div class="sharing-header">
                            <i class="fas fa-users"></i>
                            公開範囲
                        </div>
                        <select class="sharing-select" onchange="updateSharingStatus(this)">
                            <option value="none">公開設定なし</option>
                            <option value="customer" selected>お客様のみ</option>
                            <option value="business">取引先のみ</option>
                        </select>
                    </div>
                </li>

                <li class="file-item">
                    <div class="file-main">
                        <div class="file-icon image">
                            <i class="fas fa-image"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">貨物写真_001.jpg</div>
                            <div class="file-details">
                                1.8 MB • 2025/01/28 13:15
                                <span class="sharing-status business">取引先のみ</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn download" title="ダウンロード">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="file-action-btn" title="プレビュー" onclick="togglePreview(this)">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="file-action-btn delete" title="削除" onclick="deleteFile(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="file-sharing">
                        <div class="sharing-header">
                            <i class="fas fa-users"></i>
                            公開範囲
                        </div>
                        <select class="sharing-select" onchange="updateSharingStatus(this)">
                            <option value="none">公開設定なし</option>
                            <option value="customer">お客様のみ</option>
                            <option value="business" selected>取引先のみ</option>
                        </select>
                    </div>
                    <div class="file-preview" style="display: none;">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTllY2VmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuiyp+eJqeWGmeecn+ODl+ODrOODk+ODpeODvDwvdGV4dD4KICA8cG9seWdvbiBwb2ludHM9IjUwLDcwIDkwLDEzMCAxMCwxMzAiIGZpbGw9IiM2Nzc1OGQiLz4KICA8Y2lyY2xlIGN4PSIzMDAiIGN5PSIxMDAiIHI9IjMwIiBmaWxsPSIjZmZkNzAwIi8+CiAgPHJlY3QgeD0iMjUwIiB5PSIxODAiIHdpZHRoPSIxMDAiIGhlaWdodD0iODAiIGZpbGw9IiM0Mjc0N2QiLz4KICA8dGV4dCB4PSIzMDAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Q09OVEFJTkVSPC90ZXh0Pgo8L3N2Zz4=" alt="貨物写真">
                    </div>
                </li>

                <li class="file-item">
                    <div class="file-main">
                        <div class="file-icon excel">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">invoiceリスト.xlsx</div>
                            <div class="file-details">
                                856 KB • 2025/01/28 11:45
                                <span class="sharing-status none">公開設定なし</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn download" title="ダウンロード">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="file-action-btn delete" title="削除" onclick="deleteFile(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="file-sharing">
                        <div class="sharing-header">
                            <i class="fas fa-users"></i>
                            公開範囲
                        </div>
                        <select class="sharing-select" onchange="updateSharingStatus(this)">
                            <option value="none" selected>公開設定なし</option>
                            <option value="customer">お客様のみ</option>
                            <option value="business">取引先のみ</option>
                        </select>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // ★★★ここから進捗モーダル用のJSを追加★★★
        // 表示用の案件データ。実際にはフォームの入力値などから動的に生成します。
        const projectData = {
            status: '航海中', // このステータスに応じて進捗の見た目が変わります
            milestone_dates: {
                '見積収集': '2025/07/09', '見積ご案内': '2025/07/10', 'ブッキングご案内': '2025/07/12',
                '書類準備完了': '2025/07/18', '出航': '2025/07/20'
            }
        };

        const MILESTONE_TEMPLATE = ['見積収集', '見積ご案内', 'ブッキングご案内', '書類準備完了', '出航', '到着', '請求書発行'];
        const STATUS_ORDER = {
            '見積もり作成中': 0, 'ブッキング依頼中': 1, '書類準備中': 2,
            '本船出航待ち': 3, '航海中': 4, '請求書発行待ち': 5, '完了': 6
        };

        function getMilestonesForProject(project) {
            const currentStatusIndex = STATUS_ORDER[project.status];
            return MILESTONE_TEMPLATE.map((name, index) => {
                let status = 'pending';
                if (project.status === '完了' || index < currentStatusIndex) {
                    status = 'complete';
                } else if (index === currentStatusIndex) {
                    status = 'current';
                }
                return { name, status };
            });
        }

        function showMilestoneModal() {
            // 基本情報セクションからMBLとHBLのinput要素を取得
            const mblInput = document.querySelector('#basicInfo input[placeholder="MBL NO."]');
            const hblInput = document.querySelector('#basicInfo input[placeholder="HBL NO."]');

            const mbl = mblInput ? mblInput.value.trim() : '';
            const hbl = hblInput ? hblInput.value.trim() : '';

            let bl_no = '進捗状況';
            if (mbl && hbl) { bl_no = `${mbl} / ${hbl}`; }
            else if (mbl) { bl_no = mbl; }
            else if (hbl) { bl_no = hbl; }
            
            projectData.bl_no = bl_no;

            const overlay = document.getElementById('milestone-modal-overlay');
            const title = document.getElementById('modal-project-title');
            const content = document.getElementById('milestone-modal-content');

            title.textContent = projectData.bl_no;
            
            const milestones = getMilestonesForProject(projectData);
            let html = '<ul class="milestone-list">';
            milestones.forEach(milestone => {
                const iconClass = milestone.status === 'complete' ? 'fas fa-check' :
                                  milestone.status === 'current' ? 'fas fa-clock' : 'fas fa-circle';
                html += `
                    <li class="milestone-item">
                        <div class="milestone-icon ${milestone.status}">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="milestone-content">
                            <div class="milestone-name">${milestone.name}</div>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            content.innerHTML = html;

            document.body.style.overflow = 'hidden';
            overlay.classList.add('active');
        }

        function closeMilestoneModal() {
            const overlay = document.getElementById('milestone-modal-overlay');
            overlay.classList.remove('active');
            if (!document.querySelector('.file-panel.active')) {
                document.body.style.overflow = '';
            }
        }
        // ★★★ここまで進捗モーダル用のJS★★★

        // フォーム要素のインタラクション
        document.querySelectorAll('.form-input, .form-select, .form-textarea, .table-input, .container-type-select').forEach(input => {
            input.addEventListener('focus', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.2)';
            });
            
            input.addEventListener('blur', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });

        // アコーディオン機能
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        // チャット最小化/最大化機能
        function toggleChat(chatId) {
            const chatWidget = document.getElementById(chatId);
            const toggleButton = chatWidget.querySelector('.chat-toggle');
            chatWidget.classList.toggle('minimized');
            toggleButton.textContent = chatWidget.classList.contains('minimized') ? '+' : '−';
        }

        // チャット機能
        document.querySelectorAll('.chat-input input').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim()) {
                    const chatContent = this.closest('.chat-widget').querySelector('.chat-content');
                    const message = document.createElement('div');
                    message.className = 'chat-message';
                    message.innerHTML = `<strong>担当者 ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</strong><br>${this.value}`;
                    chatContent.appendChild(message);
                    chatContent.scrollTop = chatContent.scrollHeight;
                    this.value = '';
                }
            });
        });

        // 保存ボタンのアニメーション
        document.querySelector('.btn-primary').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
            this.style.background = '#45a049';
            
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-check"></i> 保存完了';
                this.style.background = '#4CAF50';
                
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-save"></i> 保存';
                }, 2000);
            }, 1500);
        });

        // 自動保存機能
        let autoSaveTimer;
        document.querySelectorAll('.form-input, .form-select, .form-textarea, .table-input, .container-type-select').forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    console.log('自動保存実行');
                }, 3000);
            });
        });

        // コンテナ情報テーブルに行を追加する関数
        function addContainerRow() {
            const tbody = document.querySelector('#containerInfo .cargo-table tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" class="table-input container-number-input" placeholder="コンテナ番号"></td>
                <td>
                    <select class="container-type-select">
                        <option value="">選択</option><option value="Dry">Dry</option><option value="Reefer">Reefer</option><option value="OT">OT</option><option value="FR">FR</option>
                    </select>
                </td>
                <td>
                    <select class="container-type-select">
                        <option value="">選択</option><option value="20'">20'</option><option value="40'">40'</option><option value="40'HC">40'HC</option>
                    </select>
                </td>
                <td><input type="text" class="table-input seal-number-input" placeholder="シール番号"></td>
                <td><input type="text" class="table-input" placeholder="備考"></td>
            `;
            addInputEventListeners(newRow);
        }

        // 商品情報テーブルに行を追加する関数
        function addCargoRow() {
            const tbody = document.querySelector('#productInfo .cargo-table tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="number" class="table-input"></td><td><input type="number" class="table-input"></td><td><input type="number" class="table-input"></td>
                <td><input type="text" class="table-input"></td><td><input type="number" class="table-input"></td><td><input type="text" class="table-input"></td>
                <td><input type="number" class="table-input"></td><td><input type="number" class="table-input"></td>
            `;
            addInputEventListeners(newRow);
        }

        // 入力フィールドにイベントリスナーを追加する共通関数
        function addInputEventListeners(row) {
            row.querySelectorAll('.table-input, .container-type-select').forEach(input => {
                input.addEventListener('focus', function() { this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.2)'; });
                input.addEventListener('blur', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = 'none'; });
                input.addEventListener('input', function() {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => { console.log('自動保存実行'); }, 3000);
                });
            });
        }

        // 添付ファイルサイドパネルの機能
        function toggleFilePanel() {
            document.getElementById('filePanelOverlay').classList.add('active');
            document.getElementById('filePanel').classList.add('active');
        }

        function closeFilePanel() {
            document.getElementById('filePanelOverlay').classList.remove('active');
            document.getElementById('filePanel').classList.remove('active');
        }

        // 公開範囲ステータス更新機能
        function updateSharingStatus(selectElement) {
            const fileItem = selectElement.closest('.file-item');
            const statusBadge = fileItem.querySelector('.sharing-status');
            const selectedValue = selectElement.value;
            statusBadge.className = `sharing-status ${selectedValue}`;
            const statusText = {'customer': 'お客様のみ', 'business': '取引先のみ', 'none': '公開設定なし'};
            statusBadge.textContent = statusText[selectedValue];
        }

        // ファイル削除機能
        function deleteFile(button) {
            if (confirm('このファイルを削除しますか？')) {
                const fileItem = button.closest('.file-item');
                fileItem.style.transition = 'opacity 0.3s, transform 0.3s';
                fileItem.style.opacity = '0';
                fileItem.style.transform = 'translateX(100%)';
                setTimeout(() => { fileItem.remove(); updateFileCounter(); }, 300);
            }
        }

        // プレビュー表示切り替え
        function togglePreview(button) {
            const preview = button.closest('.file-item').querySelector('.file-preview');
            const isHidden = preview.style.display === 'none' || preview.style.display === '';
            preview.style.display = isHidden ? 'block' : 'none';
            button.innerHTML = isHidden ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        }

        // ファイル数カウンター更新
        function updateFileCounter() {
            const fileCount = document.querySelectorAll('#fileList .file-item').length;
            const counter = document.getElementById('fileCounter');
            counter.textContent = fileCount;
            counter.style.display = fileCount > 0 ? 'inline-block' : 'none';
        }

        document.getElementById('fileInput').addEventListener('change', (e) => handleFiles(e.target.files));
        const uploadArea = document.querySelector('.file-upload-area');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
        uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('drag-over'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });

        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            Array.from(files).forEach(file => {
                const fileItem = document.createElement('li');
                fileItem.className = 'file-item';
                // ... (ファイル項目のHTML生成ロジックは省略)
                fileList.appendChild(fileItem);
            });
            updateFileCounter();
        }
        
        // ★★★ここからイベントリスナーの追加と修正★★★
        // DOM読み込み完了後にイベントリスナーを設定
        document.addEventListener('DOMContentLoaded', () => {
            // 元のコードにあった「進捗表示」ボタンは特定しづらいため、ヘッダー内のボタンをテキストで検索
            const buttons = document.querySelectorAll('.header-actions .btn');
            buttons.forEach(button => {
                if (button.textContent.includes('進捗表示')) {
                    button.addEventListener('click', showMilestoneModal);
                }
            });

            // 背景クリックでモーダルを閉じる
            const milestoneOverlay = document.getElementById('milestone-modal-overlay');
            if(milestoneOverlay) {
                milestoneOverlay.addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        closeMilestoneModal();
                    }
                });
            }
        });
        
        // ESCキーで開いているパネル/モーダルを閉じる
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const milestoneOverlay = document.getElementById('milestone-modal-overlay');
                const filePanelOverlay = document.getElementById('filePanelOverlay');

                if (milestoneOverlay && milestoneOverlay.classList.contains('active')) {
                    closeMilestoneModal();
                } else if (filePanelOverlay && filePanelOverlay.classList.contains('active')) {
                    closeFilePanel();
                }
            }
        });
        // ★★★ここまでイベントリスナーの追加と修正★★★
    </script>
</body>
</html>